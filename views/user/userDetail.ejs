<%- include('./userLayout/header') %>

    <header class="header-area header-style-1 header-height-2">
        <div class="header-top header-top-ptb-1 d-none d-lg-block">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-xl-3 col-lg-4">
                        <div class="header-info header-info-right">
                            <ul>
                                <% if (user) { %>
                                    <li><a href="/userDetail">
                                            <%=user.name%>
                                        </a></li>

                                    <li><a href="/userLogout">Logout</a></li>

                                    <% }else{%>
                                        <li><i class="fi-rs-user"></i><a href="/login">Log In</a></li>
                                        <% } %>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-bottom sticky-bar sticky-white-bg">
            <div class="container">
                <div class="header-wrap header-space-between position-relative">
                    <div class="logo logo-width-1">
                        <a href="index.html"><img src="/productImages/logoimages.png" alt="logo"></a>
                    </div>
                    <div
                        class="main-menu main-menu-grow main-menu-padding-1 main-menu-lh-1 main-menu-mrg-1 hm3-menu-padding d-none d-lg-block hover-boder">
                        <nav>
                            <ul>
                                <li><a href="/">Home</a>

                                </li>
                                <li><a href="/shop">Shop</a>

                                </li>
                                <li>
                                    <a href="/about">About</a>
                                </li>


                                <li>
                                    <a href="/contact">Contact</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                    <div class="header-action-right">
                        <div class="search-style-2">

                        </div>
                        <div class="header-action-2">
                            <div class="header-action-icon-2">
                                <a href="/wishlist">
                                    <img class="svgInject" alt="Evara" src="assets/imgs/theme/icons/icon-heart.svg">

                                </a>
                            </div>
                            <div class="header-action-icon-2">
                                <a class="mini-cart-icon" href="/cart">
                                    <img alt="Evara" src="assets/imgs/theme/icons/icon-cart.svg">

                                </a>

                            </div>
                            <div class="header-action-icon d-block d-lg-none">
                                <div class="burger-icon">
                                    <span class="burger-icon-top"></span>
                                    <span class="burger-icon-mid"></span>
                                    <span class="burger-icon-bottom"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="mobile-header-active mobile-header-wrapper-style">
        <div class="mobile-header-wrapper-inner">
            <div class="mobile-header-top">
                <div class="mobile-header-logo">
                    <a href="index.html"><img src="/productImages/logoimages.png" alt="logo"></a>
                </div>
                <div class="mobile-menu-close close-style-wrap close-style-position-inherit">
                    <button class="close-style search-close">
                        <i class="icon-top"></i>
                        <i class="icon-bottom"></i>
                    </button>
                </div>
            </div>
            <div class="mobile-header-content-area">
                <div class="mobile-search search-style-3 mobile-header-border">
                    <form action="#">
                        <input type="text" placeholder="Search for itemsâ€¦">
                        <button type="submit"><i class="fi-rs-search"></i></button>
                    </form>
                </div>
                <div class="mobile-menu-wrap mobile-header-border">
                </div>
                <!-- mobile menu start -->
                <nav>
                    <ul class="mobile-menu">
                        <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                href="index.html">Home</a>

                        </li>
                        <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                href="shop-grid-right.html">shop</a>

                        </li>



                    </ul>
                </nav>
                <!-- mobile menu end -->
            </div>
            <div class="mobile-header-info-wrap mobile-header-border">
                <div class="single-mobile-header-info mt-30">
                    <a href="page-contact.html"> Our location </a>
                </div>
                <div class="single-mobile-header-info">
                    <a href="page-login-register.html">Log In / Sign Up </a>
                </div>
                <div class="single-mobile-header-info">
                    <a href="#">(+01) - 2345 - 6789 </a>
                </div>
            </div>
            <div class="mobile-social-icon">
                <h5 class="mb-15 text-grey-4">Follow Us</h5>
                <a href="#"><img src="assets/imgs/theme/icons/icon-facebook.svg" alt=""></a>
                <a href="#"><img src="assets/imgs/theme/icons/icon-twitter.svg" alt=""></a>
                <a href="#"><img src="assets/imgs/theme/icons/icon-instagram.svg" alt=""></a>
                <a href="#"><img src="assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a>
                <a href="#"><img src="assets/imgs/theme/icons/icon-youtube.svg" alt=""></a>
            </div>
        </div>
    </div>
    </div>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Pages
                    <span></span> Account
                </div>
            </div>
        </div>
        <section class="pt-150 pb-150">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 m-auto">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="dashboard-menu">
                                    <ul class="nav flex-column" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab"
                                                href="#dashboard" role="tab" aria-controls="dashboard"
                                                aria-selected="false"><i
                                                    class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="accountDetail-tab" data-bs-toggle="tab"
                                                href="#accountDetail" role="tab" aria-controls="accountDetail"
                                                aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="/userAddress"><i class="fi-rs-marker mr-10"></i>My
                                                Address</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="wallet-tab" data-bs-toggle="tab" href="#wallet"
                                                role="tab" aria-controls="wallet" aria-selected="true"><i
                                                    class="fi-rs-shopping-bag mr-10"></i>Wallet</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders"
                                                role="tab" aria-controls="orders" aria-selected="false"><i
                                                    class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                        </li>

                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="tab-content dashboard-content">
                                    <% if (user) { %>
                                        <div class="tab-pane fade active show" id="dashboard" role="tabpanel"
                                            aria-labelledby="dashboard-tab">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0">Hello <%= user.name %>
                                                    </h5>
                                                </div>
                                                <div class="card-body">
                                                    <p>From your account dashboard, you can easily check & view your <a
                                                            href="#">recent orders</a>, manage your <a href="#">shipping
                                                            and billing addresses</a>, and <a href="#">edit your
                                                            password and account details</a>.</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md">
                                            <article class="box m-3 bg-light d-flex">
                                                <h5>Referral Code </h5> :<h5>
                                                    <%=referralCode%>
                                                </h5>
                                            </article>

                                        </div>
                                        <% } %>

                                            <div class="tab-pane fade" id="accountDetail" role="tabpanel"
                                                aria-labelledby="accountDetail-tab">
                                                <div class="col-md-8">


                                                    <div class="card">
                                                        <section class="content-body p-xl-4">
                                                            <form action="/userDetail" method="post"
                                                                onsubmit="return validationChecking()">
                                                                <div class="row">
                                                                    <div class="col-lg-8">
                                                                        <div class="row gx-3">
                                                                            <% if(user){ %>
                                                                                <input type="hidden" name="user_id"
                                                                                    value="<%=user._id%>">
                                                                                <div class="col-12 mb-3">
                                                                                    <label
                                                                                        class="form-label">Name</label>
                                                                                    <input class="form-control"
                                                                                        name="name"
                                                                                        value="<%=user.name%>"
                                                                                        id="fullName" type="text"
                                                                                        placeholder="Type here">
                                                                                    <div id="errorName"
                                                                                        class="ms-2 text-danger"></div>
                                                                                </div>
                                                                                <div class="col-lg-12 mb-3">
                                                                                    <label
                                                                                        class="form-label">Email</label>
                                                                                    <input class="form-control"
                                                                                        type="email" name="email"
                                                                                        value="<%=user.email%>"
                                                                                        id="email"
                                                                                        placeholder="type here"
                                                                                        disabled>
                                                                                    <div id="errorMail"
                                                                                        class="ms-2 text-danger"></div>
                                                                                </div>
                                                                                <div class="col-lg-12 mb-3">
                                                                                    <label
                                                                                        class="form-label">Phone</label>
                                                                                    <input class="form-control"
                                                                                        type="tel" name="mobile"
                                                                                        value="<%=user.mobile%>"
                                                                                        id="phoneNumber"
                                                                                        placeholder="type here">
                                                                                    <div id="errorMobile"
                                                                                        class="ms-2 text-danger"></div>
                                                                                </div>
                                                                                <% } %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <br>
                                                                <button id="saveChangesButton" class="btn btn-primary"
                                                                    type="submit">Save changes</button>
                                                            </form>

                                                            <hr class="my-5">
                                                            <div class="row" style="max-width:920px">
                                                                <div class="col-md">
                                                                    <article class="box mb-3 bg-light">
                                                                        <button
                                                                            class="btn float-end btn-light btn-sm rounded font-md"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#exampleModal">Change</button>
                                                                        <h6>Password</h6>
                                                                        <small class="text-muted d-block"
                                                                            style="width:70%">You can reset or change
                                                                            your password by clicking here</small>
                                                                    </article>
                                                                </div>

                                                            </div>


                                                        </section>
                                                    </div>



                                                </div>
                                            </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                            aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="exampleModalLabel">Reset Password</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="passwordChangeForm" action="/changePassword"
                                            onsubmit="return validationPasswordChecking()">
                                            <div class="form-group">
                                                <input type="password" id="password" name="password"
                                                    placeholder="Enter Current Password" />
                                                <div id="errorPassword" class="ms-2 text-danger"></div>
                                            </div>

                                            <div class="form-group">
                                                <input type="password" id="newPassword" name="newPassword"
                                                    placeholder="Enter New Password" />
                                                <div id="errornewpassword" class="ms-2 text-danger"></div>
                                            </div>

                                            <div class="form-group">
                                                <input type="password" id="confirmPassword"
                                                    placeholder="Confirm New Password" />
                                                <div id="errorconfirmPassword" class="mt-0 ms-2 text-danger"></div>
                                            </div>

                                            <div class="form-group text-center">
                                                <button type="submit"
                                                    class="btn btn-fill-out btn-block hover-up">Submit</button>
                                            </div>
                                        </form>



                                    </div>
                                </div>
                            </div>




                            <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Your Orders</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Order</th>
                                                        <th>Date</th>
                                                        <th>Total</th>
                                                        <th>Order status</th>
                                                        <th>Items</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% for( let i=order.length-1; i>=0; i--) { %>
                                                        <% let items=order[i].products.reduce((acc, product)=> acc +
                                                            product.quantity, 0) %>


                                                            <tr>
                                                                <td>
                                                                    <%=order[i].orderId %>
                                                                </td>
                                                                <td>
                                                                    <%= order[i].orderDate.toLocaleString() %>
                                                                </td>

                                                                <td>
                                                                    <%= order[i].totalAmount%>
                                                                </td>
                                                                <td>
                                                                    <%= order[i].orderStatus%>
                                                                </td>
                                                                <td>
                                                                    <%=items%>
                                                                </td>


                                                                <td>
                                                                    <a href="/orderdetail?orderId=<%=order[i]._id%>"
                                                                        class="btn-small d-block">View</a>
                                                                </td>

                                                            </tr>
                                                            <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="wallet" role="tabpanel" aria-labelledby="wallet-tab">
                                <div class="col-md-8 col-lg-10">
                                    <div class="tab-content d-flex justify-content-center align-items-center">



                                        <div class="card" style="width: 50vw; margin-top: 10px;">
                                            <div
                                                class="card-body d-flex flex-column align-items-center justify-content-center">
                                                <i class="fa-solid fa-wallet" style="font-size: 50px;"></i>


                                                <h3>Wallet Balance</h3>
                                                <p style="font-size: 30px; ">â‚¹&nbsp;<%= wallet ? wallet.walletBalance :
                                                        0 %>
                                                </p>

                                            </div>

                                        </div>

                                    </div>
                                    <div
                                        class="mt-5 card-body d-flex flex-column align-items-center justify-content-center">
                                        <table class="table" style="width: 38vw;">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Transaction Type</th>
                                                    <th scope="col">Date</th>
                                                    <th scope="col">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (wallet && wallet.transaction && wallet.transaction.length) { %>
                                                    <% for (let i=0; i < wallet.transaction.length; i++) { %>
                                                        <tr>
                                                            <td>
                                                                <span class="badge badge-pill bg-success">
                                                                    <%= wallet.transaction[i].type %>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <%= wallet.transaction[i].date.toLocaleString() %>
                                                            </td>
                                                            <td>
                                                                <span class="">
                                                                    <%= wallet.transaction[i].amount %>
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        <% } %>
                                                            <% } else { %>
                                                                <tr>
                                                                    <td colspan="3">No transactions
                                                                        available.</td>
                                                                </tr>
                                                                <% } %>
                                            </tbody>

                                        </table>
                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>



        document.addEventListener('DOMContentLoaded', function () {
            const user_name = document.getElementById("fullName");
            const errorName = document.getElementById("errorName");
            const user_phone = document.getElementById("phoneNumber");
            const errorMobile = document.getElementById("errorMobile");

            const password = document.getElementById("newPassword");
            const errorpassword = document.getElementById("errornewpassword");
            const cpassword = document.getElementById("confirmPassword");
            const errorcpassword = document.getElementById("errorconfirmPassword");


            user_name.addEventListener('input', function () {
                errorName.innerHTML = user_name.value.trim() === "" ? "Please enter user name" : /^[a-zA-Z ]+$/.test(user_name.value) == false ? "Please enter alphabets only" : "";
            });

            user_phone.addEventListener('input', function () {
                errorMobile.innerHTML = user_phone.value.trim() === "" ? "Please enter user phone number" : /^\d{10}$/.test(user_phone.value) == false ? "Please enter valid phone number" : "";
            });

            password.addEventListener('input', function () {
                errorpassword.innerHTML = password.value.trim() === "" ? "Please enter password" : password.value.length < 8 ? "Please enter a minimum of 8 characters" : "";
            });
            cpassword.addEventListener('input', function () {
                errorcpassword.innerHTML = cpassword.value.trim() === "" ? "Please enter password" : (cpassword.value !== password.value) ? "Passwords do not match" : "";
            });


        });
        function validationChecking(event) {
            const user_name = document.getElementById("fullName");
            const errorName = document.getElementById("errorName");
            const user_phone = document.getElementById("phoneNumber");
            const errorMobile = document.getElementById("errorMobile");


            errorName.innerHTML =
                user_name.value.trim() === ""
                    ? "Please enter user name"
                    : /^[a-zA-Z ]+$/.test(user_name.value) == false
                        ? "Please enter alphabets only"
                        : "";
            errorMobile.innerHTML =
                user_phone.value.trim() === ""
                    ? "Please enter user phone number"
                    : /^\d{10}$/.test(user_phone.value) == false
                        ? "Please enter valid phone number"
                        : "";

           

            if (errorName.innerHTML || errorMobile.innerHTML) return false;

            return true;
        }

        document.getElementById("passwordChangeForm").addEventListener("submit", async (e) => {
            e.preventDefault();


            const currentPassword = document.getElementById("password").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;


            const isValid = validationPasswordChecking(currentPassword, newPassword, confirmPassword);


            if (!isValid) {
                return false;
            }

            try {
               
                const response = await fetch('/changePassword', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        password: currentPassword,
                        newPassword: newPassword,
                    }),
                });


                if (response.ok) {
                    const data = await response.json();

                    // Check for success flag in the response data
                    if (!data.success) {
                        // Show SweetAlert for unsuccessful password change
                        Swal.fire({
                            title: 'Error',
                            text: 'Password change error: ' + data.message,
                            icon: 'error',
                        });
                    } else {
                        // Show SweetAlert for successful password change
                        Swal.fire({
                            icon: 'success',
                            title: 'Password Changed!',
                            text: 'Your password has been successfully changed.',
                            showConfirmButton: false,
                            timer: 2000,
                        });

                        // Wait for 2 seconds before redirecting
                        await new Promise(resolve => setTimeout(resolve, 2000));

                        // Redirect the page after password update
                        window.location.href = '/userDetail';
                    }
                } else {
                    console.error('Failed to update password:', response.status);
                    // Handle the error as needed
                    Swal.fire({
                        title: 'Error',
                        text: 'Failed to update password. Please try again.',
                        icon: 'error',
                    });
                }
            } catch (error) {
                console.error('An unexpected error occurred:', error);
                // Handle the error as needed
                Swal.fire({
                    title: 'Error',
                    text: 'An unexpected error occurred. Please try again.',
                    icon: 'error',
                });
            }
        });

        // Validation function (replace with your own implementation)
        function validationPasswordChecking(currentPassword, newPassword, confirmPassword) {

            return true;
        }


        function validationPasswordChecking(currentPassword, newPassword, confirmPassword) {
            const errorCurrentPassword = document.getElementById("errorPassword");
            const errorpassword = document.getElementById("errornewpassword");
            const errorcpassword = document.getElementById("errorconfirmPassword");

            // Reset previous error messages
            errorCurrentPassword.textContent = "";
            errorpassword.textContent = "";
            errorcpassword.textContent = "";

            // Validation for the current password
            if (currentPassword.trim() === "") {
                errorCurrentPassword.textContent = "Please enter current password";
            }

            // Validation for the new password
            if (newPassword.trim() === "") {
                errorpassword.textContent = "Please enter password";
            } else if (newPassword.length < 8) {
                errorpassword.textContent = "Please enter a minimum of 8 characters";
            }

            // Validation for the confirm password
            if (confirmPassword.trim() === "") {
                errorcpassword.textContent = "Please enter password";
            } else if (confirmPassword !== newPassword) {
                errorcpassword.textContent = "Passwords do not match";
            }

            // Check if any validation error exists
            return !(errorCurrentPassword.textContent || errorpassword.textContent || errorcpassword.textContent);
        }

        function updateErrorMessages(errorMessage) {
            // Update the error message on the page
            const errorCurrentPassword = document.getElementById("errorCurrentPassword");
            errorCurrentPassword.textContent = errorMessage;
        }

        document.getElementById("saveChangesButton").addEventListener("click", async function (event) {
    event.preventDefault();

    const isValid = validationChecking();

    if (isValid) {
        const formData = {
            user_id: document.querySelector('input[name="user_id"]').value,
            name: document.querySelector('input[name="name"]').value,
            mobile: document.querySelector('input[name="mobile"]').value,
        };

        try {
            const response = await fetch(`/userDetail`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify(formData),
            });

            const responseData = await response.json();

            if (response.ok && responseData.success) {
                Swal.fire({
                    title: 'Success!',
                    text: responseData.message,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                console.error("Error updating profile:", response.status, responseData.message);
                Swal.fire({
                    title: 'Error!',
                    text: responseData.message || 'Error updating profile.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        } catch (error) {
            console.error("An unexpected error occurred:", error);
            Swal.fire({
                title: 'Error!',
                text: "An unexpected error occurred. Please try again.",
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    } else {
        Swal.fire({
            title: 'Error!',
            text: "Please fix the validation errors before submitting.",
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
});




    </script>
    <%- include('./userLayout/footer') %>