<%- include('./userLayout/header') %>
    <section class="content-main">
        <div class="text-end me-4 mt-15 mb-3"> <button id="pdfButton" class="btn btn-secondary print ms-2"><i
                    class="icon material-icons md-print"></i> Download </button></div>

        <div class="card" id="products">
            <header class="card-header">
                <div class="container">
                    <div class="row align-items-center">
                        <div class="col-lg-4 col-md-4 mb-lg-0 mb-15">
                            <span>
                                <i class="material-icons md-calendar_today"></i> Order DATE:<b>
                                    <%= order.orderDate.toLocaleString() %>
                                </b>
                            </span> <br>
                            <small class="text-muted">Order ID:<%=order.orderId %> </small>
                        </div>
                        <div class="col-lg-4 col-md-4 ">
                            <div class="text">
                                <h6 class="mb-1">Customer</h6>
                                <small class="text-muted">CUSTOMER NAME:<%=order.userId.name %></small><br>
                                <small class="text-muted">CUSTOMER MOBILE:<%=order.userId.mobile %></small>

                                <br>
                                <a href="#">View profile</a>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-4  ">

                            <div class="text-center">
                                <h6 class="mb-1">Deliver to</h6>
                                <p class="mb-1">
                                    district:<%=order.address.district %>
                                        <br>
                                        City:<%=order.address.city %>,
                                            street:<%=order.address.street %>
                                                <br>
                                                pincode:<%=order.address.pincode %>

                                </p>
                                <a href="#">View profile</a>
                            </div>
                        </div>
                    </div>
                </div>

            </header>

            <div class="card-body">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th width="30%">Product</th>
                                            <th width="10%">Unit Price</th>
                                            <th width="10%">Quantity</th>
                                            <th width="10%" class="text-end">Total</th>
                                            <th width="15%" class="text-end">status</th>
                                            <th width="15%" class="text-end">Payment</th>
                                            <th width="15%" class="text-end">Action</th>
                                        </tr>
                                    </thead>


                                    <tbody>
                                        <% if (order) { %>
                                            <% var subtotal = 0; %>
                                            <% for (let i = 0; i < order.products.length; i++) { %>
                                                <% var total = order.products[i].productId.promotionalPrice * order.products[i].quantity; %>
                                                <% subtotal += total; %>
                                                <tr>
                                                    <td>
                                                        <a class="itemside" href="#">
                                                            <div class="left">
                                                                <img src="/productImages/<%= order.products[i].productId.images[0].filename %>" width="40" height="40" class="img-xs" alt="Item">
                                                            </div>
                                                            <div class="info">
                                                                <%= order.products[i].productId.product_title %>
                                                            </div>
                                                        </a>
                                                    </td>
                                                    <td>
                                                        ₹ <%= order.products[i].productId.promotionalPrice %>
                                                    </td>
                                                    <td>
                                                        <%= order.products[i].quantity %>
                                                    </td>
                                                    <td class="text-end">
                                                        ₹<%= total %>
                                                    </td>
                                                    <td class="text-end">
                                                        <%= order.orderStatus %>
                                                    </td>
                                                    <td class="text-end">
                                                        <%= order.paymentMethod %>
                                                    </td>
                                                    <td class="text-end">
                                                        <% if (order.orderStatus === "Order Placed") { %> 
                                                            <button class="btn bg-danger btn-sm" data-bs-toggle="modal" data-bs-target="#cancelModal<%= order.products[i].productId._id %>">Cancel</button>
                                                        
                                                        <% } else if (order.orderStatus === "Delivered") { %> 
                                                            <button class="btn bg-success btn-sm" data-bs-toggle="modal" data-bs-target="#cancelModal<%= order.products[i].productId._id %>">Return</button>
                                                       
                                                        <% } %>
                                                    </td>
                                                </tr>
                                    
                                                <div class="modal fade" id="cancelModal<%= order.products[i].productId._id %>" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="cancelModalLabel">Cancel/Return Product</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div>
                                                                    <label class="form-label">Reason</label>
                                                                    <textarea placeholder="Type here" name="reason<%= order.products[i].productId._id %>" class="form-control" rows="10" id="reason<%= order.products[i].productId._id %>"></textarea>
                                                                    <div class="error-message" style="color: red;" id="reason-error<%= order.products[i].productId._id %>"></div>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                <button type="button" class="btn btn-primary" onclick="cancelProduct('<%= order._id %>', '<%= order.products[i].productId._id %>', '<%= order.orderStatus %>')">Save changes</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            <% } %>
                                            
                                            <tr>
                                                <td colspan="5"></td>
                                                <td colspan="2">
                                                    <article>
                                                        <dl class="dlist">
                                                            <dt>Subtotal: ₹<%= subtotal %></dt>
                                                        </dl>
                                                        <dl class="dlist">
                                                            <dt>Shipping cost: ₹0.00</dt>
                                                        </dl>
                                                        <dl class="dlist">
                                                            <dt>Grand total: <b class="h5">₹<%= order.totalAmount %></b></dt>
                                                        </dl>
                                                        <dl class="dlist">
                                                            <dt class="text-muted">Status: <%= order.orderStatus %>
                                                                <span class="badge rounded-pill alert-success text-success"><%= order.paymentStatus %></span>
                                                            </dt>
                                                        </dl>
                                                    </article>
                                                </td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                    
                                    
                                    
                                    

                                </table>
                            </div> 
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <script>
       
        function cancelProduct(id, productId, status) {
    const reason = document.getElementById(`reason${productId}`).value;

    if (!reason) {
        alert('Please provide a reason for cancelling or returning the product.');
        return; // Exit the function if no reason is provided
    }

    const requestData = {
        reason,
        productId
    };
    console.log('requestData', requestData);

    let action = '';
    let confirmText = '';

    if (status === "Order Placed") {
        action = '/orderCancel';
        confirmText = 'Are you sure you want to cancel the product?';
    } else if (status === "Delivered") {
        action = '/return';
        confirmText = 'Are you sure you want to return the product?';
    } else {
        alert('Invalid action');
        return;
    }

    Swal.fire({
        title: 'Confirm Action',
        text: confirmText,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, proceed',
        cancelButtonText: 'Cancel',
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`${action}?id=${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    location.reload();
                    console.log("Success:", data.message);
                } else {
                    alert('Error occurred while processing your request.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error occurred while processing your request.');
            });
        }
    });
}

        $(document).ready(function ($) {
            alert('lllllllllllllllllllllllll')
            $(document).on('click', '#pdfButton', function (event) {
                var element = document.getElementById('products');
                let randomNumber = Math.floor(Math.random() * (10000000000 - 1)) + 1;
                var opt = {
                    margin: 0,
                    filename: 'invoice' + randomNumber + '.pdf',
                    html2canvas: { scale: 10 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(element).save();

            });
        });





    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <%- include('./userLayout/footer') %>